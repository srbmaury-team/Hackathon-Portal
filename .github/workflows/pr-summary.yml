name: PR Summary Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for full git history (to diff correctly)

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate diff safely
        run: |
          echo "Fetching main branch..."
          git fetch origin main || echo "⚠️ No main branch found on origin"

          echo "Finding merge base..."
          MERGE_BASE=$(git merge-base origin/main HEAD 2>/dev/null || echo "")
          if [ -z "$MERGE_BASE" ]; then
            echo "⚠️ No common base with main — generating full diff instead."
            git diff > changes.diff
          else
            echo "✅ Found merge base: $MERGE_BASE"
            git diff "$MERGE_BASE"...HEAD > changes.diff
          fi

          echo "Generated diff size: $(wc -c < changes.diff) bytes"

      - name: Summarize changes using OpenAI
        id: summarize
        uses: openai/openai-summary-action@v1
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          input_file: changes.diff
          model: gpt-4o-mini
          instructions: |
            Generate a concise, professional PR summary for reviewers.
            Highlight key file changes, feature updates, bug fixes, and refactors.
            Avoid unnecessary technical details unless important for understanding the impact.

      - name: Comment PR summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "🧠 AI-Powered PR Summary"
          message: |
            ${{ steps.summarize.outputs.summary }}

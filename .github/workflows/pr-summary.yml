name: PR Summary Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch main branch
        run: |
          git fetch origin main || echo "No main branch found"

      - name: Generate diff
        run: |
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            git diff origin/main...HEAD > changes.diff
          else
            echo "No common base with main, generating full diff"
            git diff > changes.diff
          fi

      - name: Generate and Post PR Summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "üß† Generating summary using ChatGPT..."

          DIFF_CONTENT=$(head -c 12000 changes.diff | jq -Rs .)

          REQUEST_BODY=$(jq -n --arg diff "$DIFF_CONTENT" '{
            model: "gpt-5",
            messages: [
              {role: "system", content: "You are a helpful AI that summarizes GitHub pull requests clearly and concisely."},
              {role: "user", content: ("Summarize these PR changes in 3‚Äì5 bullet points:\n\n\($diff)")}
            ]
          }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$REQUEST_BODY")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$SUMMARY" ]; then
            echo "‚ùå Failed to generate summary. Full API response:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "‚úÖ Summary generated successfully."
          echo "$SUMMARY"

          echo "üí¨ Posting summary as PR comment..."
          curl -s -H "Authorization: token $GH_PAT" \
            -X POST \
            -d "{\"body\": \"### ü§ñ AI Summary\n$SUMMARY\"}" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"

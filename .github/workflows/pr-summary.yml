name: üß† PR Summary Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  summarize:
    name: Generate PR Summary
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # <-- important! ensures full git history

      - name: üîÑ Ensure main branch is available
        run: |
          git fetch origin main
          echo "‚úÖ Main branch fetched."

      - name: üìÑ Generate PR diff
        run: |
          BASE_BRANCH=$(git merge-base origin/main HEAD || echo "")
          if [ -z "$BASE_BRANCH" ]; then
            echo "‚ö†Ô∏è No merge base found. Using origin/main as base."
            git diff origin/main > changes.diff
          else
            git diff $BASE_BRANCH > changes.diff
          fi
          echo "‚úÖ Diff file created."
          head -n 20 changes.diff || echo "Diff preview done."

      - name: ü§ñ Generate PR Summary using ChatGPT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "üß† Generating AI summary for PR #$PR_NUMBER..."

          SUMMARY=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-5",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert AI assistant that summarizes GitHub pull requests concisely and clearly."
                },
                {
                  "role": "user",
                  "content": "Summarize the following Git diff in 3‚Äì5 concise bullet points:\n\n'"$(head -c 12000 changes.diff)"'"
                }
              ],
              "temperature": 0.3
            }' | jq -r '.choices[0].message.content')

          echo "‚úÖ Summary generated:"
          echo "$SUMMARY"

          curl -s -H "Authorization: token $GH_TOKEN" \
            -X POST \
            -d "{\"body\": \"### ü§ñ AI-Generated Summary\n\n$SUMMARY\"}" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"

          echo "üí¨ Summary comment posted to PR #$PR_NUMBER."
